<!DOCTYPE html><html lang="en" prefix="og: https://ogp.me/ns#">
    <head>
        <title>Devlog #6</title>
        <link href="https://fonts.googleapis.com/css2?family=IBM+Plex+Sans&family=Rajdhani" rel="stylesheet"/>
        <link href="https://fonts.googleapis.com/css?family=Lato&display=swap" rel="stylesheet"/>
        <link href="https://stackpath.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" rel="stylesheet"/>
        <link href="/component-asciidoctor.css" rel="stylesheet"/>
        <link href="/component-asciidoctor-override.css" rel="stylesheet"/>
        <link href="/component-asciidoctor-color-override.css" rel="stylesheet"/>
        <link href="/css/docs-base.css" rel="stylesheet"/>
<link href="/css/blog-layout.css" rel="stylesheet"/><link href="/css/blog-email-signup.css" rel="stylesheet"/>        <link href="/css/normalize-8.0.1.css" rel="stylesheet"/><link href="/css/prettify.css" rel="stylesheet"/>
        <meta name="twitter:card" content="summary"/>
        <meta name="twitter:site" content="@nokeedev"/>
        <meta name="twitter:creator" content="@lacasseio"/>
        <meta name="twitter:title" content="Devlog #6"/>
        <meta name="twitter:description" content="Development log #6"/>

        <meta property="og:url" content="https://blog.nokee.dev/devlog-6/"/>
        <meta property="og:site_name" content="Nokee"/>
        <meta property="og:title" content="Devlog #6"/>
        <meta property="og:description" content="Development log #6"/>

        <meta charset="utf-8"/>
<meta name="viewport" content="width=device-width, initial-scale=1.0"/>

        <meta name="author" content="Nokee"/>
        <meta name="keywords" content="devlog"/>
        <meta name="description" content="Development log #6"/>
        <link rel="canonical" href="https://blog.nokee.dev/devlog-6/"/>
        <link href="/component-menu.css" rel="stylesheet"/>
        <link href="/component-menu-light.css" rel="stylesheet"/>

        <link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"/>
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-light-32x32.png" media="(prefers-color-scheme: light)"/>
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-light-16x16.png" media="(prefers-color-scheme: light)"/>
        <link rel="icon" type="image/png" sizes="32x32" href="/favicon-dark-32x32.png" media="(prefers-color-scheme: dark)"/>
        <link rel="icon" type="image/png" sizes="16x16" href="/favicon-dark-16x16.png" media="(prefers-color-scheme: dark)"/>
        <link rel="manifest" href="/site.webmanifest"/>
        <link rel="mask-icon" href="/safari-pinned-tab.svg" color="#001824"/>
        <meta name="msapplication-TileColor" content="#00a300"/>
        <meta name="theme-color" content="#ffffff"/>
        
    </head>
    <body onload="prettyPrint()">
        <nav class="navigation" aria-labelledby="primary-navigation">
            <a href="https://blog.nokee.dev" class="logo">
                <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 49.96"><defs></defs><g id="Layer_2" data-name="Layer 2"><g id="Layer_1-2" data-name="Layer 1"><g id="full-dark"><g id="nokee"><path d="M180.38,40.13a6.32,6.32,0,0,1-6.25-6.25V18.37a6.32,6.32,0,0,1,6.25-6.25H193.8A5.92,5.92,0,0,1,198.17,14a6,6,0,0,1,1.83,4.4V28.88H180.49s-.05,4.85,0,4.89,19.51.07,19.51.07v6.29Zm.11-16.84h13.15V18.48H180.49Z"/><path d="M51.3,40.13v-28H71A6,6,0,0,1,75.34,14a6,6,0,0,1,1.83,4.4V40.13H70.88l-.07-21.65H57.65l-.06,21.65Z"/><path d="M88.94,40.13a6.32,6.32,0,0,1-6.25-6.25V18.37a6.32,6.32,0,0,1,6.25-6.25h13.42A6,6,0,0,1,106.74,14a6.07,6.07,0,0,1,1.82,4.4V33.88a6.05,6.05,0,0,1-1.82,4.4,5.92,5.92,0,0,1-4.38,1.85Zm13.26-6.36s0-15.29,0-15.29H89.05s0,15.25,0,15.29S102.16,33.82,102.2,33.77Z"/><path d="M114.13,40.13V6.26h6.29V23.38h4l8.84-11.28h8.19L129.92,26.54l11.49,13.59h-8.19l-8.84-10.42h-4V40.13Z"/><path d="M149.25,40.13A6.32,6.32,0,0,1,143,33.88V18.37a6.32,6.32,0,0,1,6.25-6.25h13.42A6,6,0,0,1,167.05,14a6.07,6.07,0,0,1,1.82,4.4V28.88H149.36s-.05,4.85,0,4.89,19.51.07,19.51.07v6.29Zm.11-16.84h13.15V18.48H149.36Z"/></g><g id="bird"><path d="M41.82,10.21,25.58.83a6.24,6.24,0,0,0-6.23,0L3.11,10.21A6.24,6.24,0,0,0,0,15.6V34.35a6.25,6.25,0,0,0,3.11,5.4l16.24,9.37a6.24,6.24,0,0,0,6.23,0l16.24-9.37a6.25,6.25,0,0,0,3.11-5.4V15.6A6.24,6.24,0,0,0,41.82,10.21Zm-6,10.92c0,12.59-7.92,17.46-21.73,17.46A16.46,16.46,0,0,1,5,36c8.22-5.58,10.56-9.95,12.4-17.5,1.11-4.54,4.25-8.06,9.22-8.06,3.6,0,6.62,1.28,8.14,4.7h6.5l-5.49,4.39C35.82,20,35.84,20.57,35.84,21.13Z"/><path d="M28.94,13.72a3.35,3.35,0,0,0-3,1.76.83.83,0,0,0,1.46.79,1.7,1.7,0,0,1,3,0,.83.83,0,0,0,1.13.33.82.82,0,0,0,.33-1.12A3.36,3.36,0,0,0,28.94,13.72Z"/></g></g></g></g></svg>

            </a><input class="navigation-hamburger" type="checkbox" id="navigation-hamburger"/><label class="menu-icon" for="navigation-hamburger">
                <span class="navicon"></span>
            </label><ul class="navigation-items">
                <li><a href="https://docs.nokee.dev">Docs</a></li><li><a href="https://blog.nokee.dev">Blog</a></li><li><a href="https://nokee.dev/services/consulting.html">Services</a></li><li>
                    <ul class="navigation-socials">
                        <li class="navigation-twitter">
                            <a href="https://twitter.com/nokeedev" title="Nokee on Twitter">
                                <svg width="24" height="24" viewBox="0 0 56.693 56.693" xmlns="http://www.w3.org/2000/svg"><path d="M28.348,5.157c-13.6,0-24.625,11.027-24.625,24.625c0,13.6,11.025,24.623,24.625,24.623c13.6,0,24.623-11.023,24.623-24.623  C52.971,16.184,41.947,5.157,28.348,5.157z M40.752,24.817c0.013,0.266,0.018,0.533,0.018,0.803c0,8.201-6.242,17.656-17.656,17.656  c-3.504,0-6.767-1.027-9.513-2.787c0.486,0.057,0.979,0.086,1.48,0.086c2.908,0,5.584-0.992,7.707-2.656  c-2.715-0.051-5.006-1.846-5.796-4.311c0.378,0.074,0.767,0.111,1.167,0.111c0.566,0,1.114-0.074,1.635-0.217  c-2.84-0.57-4.979-3.08-4.979-6.084c0-0.027,0-0.053,0.001-0.08c0.836,0.465,1.793,0.744,2.811,0.777  c-1.666-1.115-2.761-3.012-2.761-5.166c0-1.137,0.306-2.204,0.84-3.12c3.061,3.754,7.634,6.225,12.792,6.483  c-0.106-0.453-0.161-0.928-0.161-1.414c0-3.426,2.778-6.205,6.206-6.205c1.785,0,3.397,0.754,4.529,1.959  c1.414-0.277,2.742-0.795,3.941-1.506c-0.465,1.45-1.448,2.666-2.73,3.433c1.257-0.15,2.453-0.484,3.565-0.977  C43.018,22.849,41.965,23.942,40.752,24.817z"/></svg>

                            </a>
                        </li><li class="navigation-github">
                            <a href="https://github.com/nokeedev" title="Nokee on GitHub">
                                <svg width="20" height="20" viewBox="0 0 20 20" xmlns="http://www.w3.org/2000/svg"><title>GitHub</title><path d="M10 0C4.477 0 0 4.477 0 10c0 4.418 2.865 8.166 6.839 9.489.5.092.682-.217.682-.482 0-.237-.008-.866-.013-1.7-2.782.603-3.369-1.342-3.369-1.342-.454-1.155-1.11-1.462-1.11-1.462-.908-.62.069-.608.069-.608 1.003.07 1.531 1.03 1.531 1.03.892 1.529 2.341 1.087 2.91.831.092-.646.35-1.086.636-1.336-2.22-.253-4.555-1.11-4.555-4.943 0-1.091.39-1.984 1.029-2.683-.103-.253-.446-1.27.098-2.647 0 0 .84-.268 2.75 1.026A9.578 9.578 0 0 1 10 4.836c.85.004 1.705.114 2.504.337 1.909-1.294 2.747-1.026 2.747-1.026.546 1.377.203 2.394.1 2.647.64.699 1.028 1.592 1.028 2.683 0 3.842-2.339 4.687-4.566 4.935.359.309.678.919.678 1.852 0 1.336-.012 2.415-.012 2.743 0 .267.18.579.688.481C17.137 18.163 20 14.418 20 10c0-5.523-4.478-10-10-10" fill-rule="evenodd"></path></svg>

                            </a>
                        </li>
                    </ul>
                </li>
            </ul>
        </nav>

        <main class="main-content">
<div class="chapter">
                <div id="header">
<h1>Devlog #6</h1><p><em>20 September 2022</em></p>                    
                </div>
                <div id="content">
                    
                    <div id="preamble">
<div class="sectionbody">
<div class="paragraph">
<p>This week&#8217;s development log (devlog) is a three-for-one special and includes work done since the <a href="/devlog-5/">last devlog</a>, published a while ago.
We split our primary development time between improvement to the language source set model, and the Xcode build adapter.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="language_source_set_improvements"><a class="anchor" href="#language_source_set_improvements"></a><a class="link" href="#language_source_set_improvements">Language Source Set Improvements</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>For a while now, we had two competing <code>LanguageSourceSet</code> implementations.
When we first introduced the concept, our chosen design focused on declaring the sources and headers.
We borrow some ideas from the software model core plugins.
The models were single bags of files that didn&#8217;t correctly represent reality and didn&#8217;t allow for ad-hoc declaration of source sets.
The second concept initially introduced in the JNI library plugin focuses on software composition.
In short, declaring a <code>LanguageSourceSet</code> implied the sources, their headers, a compile task, and consumable dependencies.
We can use the source set alone to create object files or as part of a more complex hiearchy such as an executable binary.
Thanks to our universal model, we can clearly define the owner and simple rules that will automatically complete native components with the right source set.
The last part is much more complicated than it seems.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="xcode_build_adapter_improvements"><a class="anchor" href="#xcode_build_adapter_improvements"></a><a class="link" href="#xcode_build_adapter_improvements">Xcode Build Adapter Improvements</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>As we onboarded more real-life projects with our Xcode build adapter plugin, it became clear that support for cross-project dependencies was necessary.
Previously, we only supported implicit dependencies via Xcode workspace.
We took a step back and made a deeper analysis of our Xcode model which led to the following graph <sup class="footnote">[<a id="_footnoteref_1" class="footnote" href="#_footnotedef_1" title="View footnote.">1</a>]</sup>:</p>
</div>
<div class="imageblock">
<div class="content">
<img src="xcode-model.png" alt="PBXProj models as understood by the Xcode build system">
</div>
<div class="title">Figure 1. PBXProj models and relationships</div>
</div>
<div class="paragraph">
<p>One thing that stands out from our research is how simple yet powerful the Xcode build system is.
We need a stellar understanding of Xcode to ensure proper up-to-date checking, caching and parallelization.</p>
</div>
<div class="paragraph">
<p>The first step was to deserialize cross-project reference from the PBXProj properly.
It allows us to understand cross-project dependencies and remote product references (e.g. file references declared in another project).
Then, we perform an additional discovery step during configuration to find the effective list of Xcode projects participating in the build.
Finally, we use the Gradle dependency engine to process project dependencies (implicit, explicit and cross-project).</p>
</div>
<div class="paragraph">
<p>This small change to how we handle Xcode projects allows for deeper insight into the build process via build scan:</p>
</div>
<div class="imageblock">
<div class="content">
<a class="image" href="https://scans.gradle.com/s/xgn7sfgn7ykya/timeline"><img src="vlc-ios-build-scan.png" alt="Build scan timeline of VLC iOS build"></a>
</div>
<div class="title">Figure 2. Build scan of vlc-ios project</div>
</div>
<div class="paragraph">
<p>As we can see, all targets are independent, even if they come from the same project.
Previously all targets of a single project were treated as a single cluster.
To successfully break down target clusters, we preprocess the Xcode project before delegating the build to <code>xcodebuild</code>.
Thanks to the simplicity of the Xcode build system, we can trick Xcode into consuming our previously built products as part of a different and independent invocation.</p>
</div>
<div class="paragraph">
<p>Our next focus will be improving the configuration of Gradle&#8217;s superior up-to-date check by extracting more accurate information from Xcode projects.</p>
</div>
</div>
</div>
<div class="sect1">
<h2 id="ad_hoc_artifact_repositories"><a class="anchor" href="#ad_hoc_artifact_repositories"></a><a class="link" href="#ad_hoc_artifact_repositories">Ad-hoc Artifact Repositories</a></h2>
<div class="sectionbody">
<div class="paragraph">
<p>Our plugins still rely on core native support in Gradle to discover and locate native toolchains.
It isn&#8217;t ideal for us, given our lack of control over such critical infrastructure.
For a long while, we had a plan to select native toolchains (and system libraries) using the Gradle dependency engine.
Recently, <a href="https://github.com/nokeedev/gradle-native/pull/708">we pushed the first part of this plan which introduces the concept of ad-hoc artifact repositories</a>.
They are on-disk Maven repositories with a twist!
The repository provides callbacks to generate the repository&#8217;s content before completing the resolution.
We did countless experiments, and this solution was by far the simplest.
We still rely on internal Gradle APIs, so we don&#8217;t expect users to interact directly with those repositories.
However, it marks the first step toward better native dependency management (including Conan support).
We already migrated our macOS framework dependency support from the dreadful embedded Jetty server to an ad-hoc repository.</p>
</div>
</div>
</div>
<div id="footnotes">
<hr>
<div class="footnote" id="_footnotedef_1">
<a href="#_footnoteref_1">1</a>. We are developing the <a href="https://github.com/nokeedev/gradle-native/blob/master/subprojects/xcode-ide-kit/src/docs/pbxproj.dot">graph</a> organically based on the development need.
</div>
</div>
                    
                </div>
            </div>            
        </main>
        <div id="push"></div>
			<!-- Begin Mailchimp Signup Form -->
			<p style="text-align:center">Stay on top of new features and news by subscribing:</p>
			<div id="mc_embed_signup">
				<form action="https://dev.us4.list-manage.com/subscribe/post?u=c1b91750dbe075432c8729552&amp;id=93402e2466" method="post" id="mc-embedded-subscribe-form" name="mc-embedded-subscribe-form" class="validate" target="_blank" novalidate>
					<div id="mc_embed_signup_scroll">

					<input type="email" value="" name="EMAIL" class="email" id="mce-EMAIL" placeholder="email address" required>
					<!-- real people should not fill this in and expect good things - do not remove this or risk form bot signups-->
					<div style="position: absolute; left: -5000px;" aria-hidden="true"><input type="text" name="b_c1b91750dbe075432c8729552_93402e2466" tabindex="-1" value=""></div>
					<div class="clear"><input type="submit" value="Subscribe" name="subscribe" id="mc-embedded-subscribe" class="button"></div>
					</div>
					<small>* We will never send spam, and you can unsubscribe at any time</small>
				</form>
			</div>

			<!--End mc_embed_signup-->
		<div id="push"></div><div id="footer">
            <div class="container">
                <p class="muted credit">&copy; 2020</p>
            </div>
        </div>
<script src="/js/prettify.js"></script>
    </body>
</html>
